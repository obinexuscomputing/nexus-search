/**
 * @obinexuscomputing/nexus-search v0.1.57
 * A high-performance search indexing and query system that uses a trie data structure and BFS/DFS algorithms for fast full-text search with fuzzy matching.
 * @license ISC
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("idb")):"function"==typeof define&&define.amd?define(["exports","idb"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).NexusSearch={},e.idb)}(this,(function(e,t){"use strict";class i{getSize(){return this.cache.size}getStatus(){const e=Array.from(this.cache.values()).map((e=>e.timestamp)),t=Date.now(),i=this.calculateMemoryUsage();return{size:this.cache.size,maxSize:this.maxSize,strategy:this.strategy,ttl:this.ttl,utilization:this.cache.size/this.maxSize,oldestEntryAge:e.length?t-Math.min(...e):null,newestEntryAge:e.length?t-Math.max(...e):null,memoryUsage:{bytes:i,formatted:this.formatBytes(i)}}}calculateMemoryUsage(){let e=0;for(const[t,i]of this.cache.entries())e+=2*t.length,e+=24,e+=this.estimateDataSize(i.data);return e+=8*(3+this.accessOrder.length+3),e}estimateDataSize(e){let t=0;for(const i of e)t+=8,t+=2*i.matches.join("").length,t+=2*JSON.stringify(i.item).length,i.metadata&&(t+=2*JSON.stringify(i.metadata).length);return t}formatBytes(e){const t=["B","KB","MB","GB"];let i=e,s=0;for(;i>=1024&&s<t.length-1;)i/=1024,s++;return`${i.toFixed(2)} ${t[s]}`}constructor(e=1e3,t=5,i="LRU"){this.cache=new Map,this.maxSize=e,this.ttl=60*t*1e3,this.strategy=i,this.accessOrder=[],this.stats={hits:0,misses:0,evictions:0}}set(e,t){this.cache.size>=this.maxSize&&this.evict();const i={data:t,timestamp:Date.now(),lastAccessed:Date.now(),accessCount:1};this.cache.set(e,i),this.updateAccessOrder(e)}get(e){const t=this.cache.get(e);return t?this.isExpired(t.timestamp)?(this.cache.delete(e),this.removeFromAccessOrder(e),this.stats.misses++,null):(t.lastAccessed=Date.now(),t.accessCount++,this.updateAccessOrder(e),this.stats.hits++,t.data):(this.stats.misses++,null)}clear(){this.cache.clear(),this.accessOrder=[],this.stats={hits:0,misses:0,evictions:0}}getStats(){return{...this.stats,size:this.cache.size,maxSize:this.maxSize,hitRate:this.stats.hits/(this.stats.hits+this.stats.misses),strategy:this.strategy}}isExpired(e){return Date.now()-e>this.ttl}evict(){const e="LRU"===this.strategy?this.findLRUKey():this.findMRUKey();e&&(this.cache.delete(e),this.removeFromAccessOrder(e),this.stats.evictions++)}findLRUKey(){return this.accessOrder[0]||null}findMRUKey(){return this.accessOrder[this.accessOrder.length-1]||null}updateAccessOrder(e){this.removeFromAccessOrder(e),"LRU"===this.strategy?this.accessOrder.push(e):this.accessOrder.unshift(e)}removeFromAccessOrder(e){const t=this.accessOrder.indexOf(e);-1!==t&&this.accessOrder.splice(t,1)}setStrategy(e){if(e===this.strategy)return;this.strategy=e;const t=[...this.accessOrder];this.accessOrder=[],t.forEach((e=>this.updateAccessOrder(e)))}prune(){let e=0;for(const[t,i]of this.cache.entries())this.isExpired(i.timestamp)&&(this.cache.delete(t),this.removeFromAccessOrder(t),e++);return e}analyze(){const e=this.stats.hits+this.stats.misses,t=e>0?this.stats.hits/e:0;let i=0;const s=new Map;for(const[e,t]of this.cache.entries())i+=t.accessCount,s.set(e,t.accessCount);return{hitRate:t,averageAccessCount:this.cache.size>0?i/this.cache.size:0,mostAccessedKeys:Array.from(s.entries()).sort(((e,t)=>t[1]-e[1])).slice(0,5).map((([e,t])=>({key:e,count:t})))}}}class s{constructor(e={type:"memory"}){this.db=null,this.memoryStorage=new Map,this.storageType=this.determineStorageType(e)}determineStorageType(e){return"memory"!==e.type&&this.isIndexedDBAvailable()?"indexeddb":"memory"}isIndexedDBAvailable(){try{return"undefined"!=typeof indexedDB&&null!==indexedDB}catch(e){return!1}}async initialize(){if("memory"!==this.storageType)try{this.db=await t.openDB("nexus-search-db",1,{upgrade(e){e.createObjectStore("searchIndices",{keyPath:"id"}).createIndex("timestamp","timestamp");e.createObjectStore("metadata",{keyPath:"id"}).createIndex("lastUpdated","lastUpdated")}})}catch(e){this.storageType="memory",console.warn("Failed to initialize IndexedDB, falling back to memory storage:",e)}}async storeIndex(e,t){var i;if("memory"!==this.storageType)try{await(null===(i=this.db)||void 0===i?void 0:i.put("searchIndices",{id:e,data:t,timestamp:Date.now()}))}catch(i){console.error("Storage error:",i),this.memoryStorage.set(e,t)}else this.memoryStorage.set(e,t)}async getIndex(e){var t;if("memory"===this.storageType)return this.memoryStorage.get(e);try{const i=await(null===(t=this.db)||void 0===t?void 0:t.get("searchIndices",e));return null==i?void 0:i.data}catch(t){return console.error("Retrieval error:",t),this.memoryStorage.get(e)}}async clearIndices(){var e;if("memory"!==this.storageType)try{await(null===(e=this.db)||void 0===e?void 0:e.clear("searchIndices"))}catch(e){console.error("Clear error:",e),this.memoryStorage.clear()}else this.memoryStorage.clear()}async close(){this.db&&(this.db.close(),this.db=null),this.memoryStorage.clear()}}class r{constructor(e,t,i,s=[],r=[]){this.title="",this.author="",this.tags=[],this.version="1.0",this.id=e,this.fields=this.normalizeFields(t),this.metadata=this.normalizeMetadata(i),this.versions=s,this.relations=r,this.content=this.normalizeContent(this.fields.content)}document(){return this}base(){return{id:this.id,title:this.fields.title,author:this.fields.author,tags:this.fields.tags,version:this.fields.version,versions:this.versions,relations:this.relations}}normalizeFields(e){return{...e,title:e.title||"",author:e.author||"",tags:Array.isArray(e.tags)?[...e.tags]:[],version:e.version||"1.0"}}normalizeContent(e){return"string"==typeof e?{text:e}:e||{}}normalizeMetadata(e){const t=Date.now();return{indexed:t,lastModified:t,...e}}clone(){return new r(this.id,JSON.parse(JSON.stringify(this.fields)),this.metadata?{...this.metadata}:void 0,this.versions.map((e=>({...e}))),this.relations.map((e=>({...e}))))}update(e){const t={...this.fields},i={...this.metadata,lastModified:Date.now()};return e.fields&&Object.entries(e.fields).forEach((([e,i])=>{void 0!==i&&(t[e]=i)})),e.metadata&&Object.assign(i,e.metadata),new r(this.id,t,i,e.versions||this.versions,e.relations||this.relations)}getField(e){return this.fields[e]}setField(e,t){this.fields[e]=t,this.metadata&&(this.metadata.lastModified=Date.now()),"content"===e&&(this.content=t)}addVersion(e){const t=this.versions.length+1;this.versions.push({...e,version:t}),this.fields.version=String(t),this.metadata&&(this.metadata.lastModified=Date.now())}addRelation(e){this.relations.push(e),this.metadata&&(this.metadata.lastModified=Date.now())}toObject(){return{id:this.id,fields:{...this.fields},metadata:this.metadata?{...this.metadata}:void 0,versions:this.versions.map((e=>({...e}))),relations:this.relations.map((e=>({...e}))),title:this.fields.title,author:this.fields.author,tags:this.fields.tags,version:this.fields.version}}toJSON(){return JSON.stringify(this.toObject())}toString(){return`IndexedDocument(${this.id})`}static create(e){return new r(e.id,e.fields,e.metadata,e.versions,e.relations)}static fromObject(e){return r.create({id:e.id,fields:e.fields,metadata:e.metadata,versions:e.versions||[],relations:e.relations||[],title:"",author:"",tags:[],version:""})}static fromRawData(e,t,i){return new r(e,{title:"",content:"string"==typeof t?{text:t}:t,author:"",tags:[],version:"1.0"},i)}}class n{constructor(){this.dataMap=new Map}mapData(e,t){this.dataMap.has(e)||this.dataMap.set(e,new Set),this.dataMap.get(e).add(t)}getDocuments(e){return this.dataMap.get(e)||new Set}getDocumentById(e){const t=new Set;return this.dataMap.forEach((i=>{i.has(e)&&t.add(e)})),t}getAllKeys(){return Array.from(this.dataMap.keys())}removeDocument(e){this.dataMap.forEach((t=>{t.delete(e)}))}removeKey(e){this.dataMap.delete(e)}exportState(){const e={};return this.dataMap.forEach(((t,i)=>{e[i]=Array.from(t)})),e}importState(e){this.dataMap.clear(),Object.entries(e).forEach((([e,t])=>{this.dataMap.set(e,new Set(t))}))}clear(){this.dataMap.clear()}}class o{constructor(e=0){this.children=new Map,this.isEndOfWord=!1,this.documentRefs=new Set,this.weight=0,this.frequency=0,this.lastAccessed=Date.now(),this.prefixCount=0,this.depth=e}addChild(e){const t=new o(this.depth+1);return this.children.set(e,t),t}getChild(e){return this.children.get(e)}hasChild(e){return this.children.has(e)}incrementWeight(e=1){this.weight+=e,this.frequency++,this.lastAccessed=Date.now()}decrementWeight(e=1){this.weight=Math.max(0,this.weight-e),this.frequency=Math.max(0,this.frequency-1)}clearChildren(){this.children.clear(),this.documentRefs.clear(),this.weight=0,this.frequency=0}shouldPrune(){return 0===this.children.size&&0===this.documentRefs.size&&0===this.weight&&0===this.frequency}getScore(){const e=Math.exp(-(Date.now()-this.lastAccessed)/864e5);return this.weight*this.frequency*e/(this.depth+1)}getWeight(){return this.weight}}class a{insert(e,t){this.insertWord(e,t)}removeData(e){this.removeDocument(e)}constructor(e=50){this.root=new o,this.documents=new Map,this.documentLinks=new Map,this.totalDocuments=0,this.maxWordLength=e}addDocument(e){e.id&&(this.documents.set(e.id,e),this.totalDocuments++,Object.values(e.fields).forEach((t=>{"string"==typeof t?this.indexText(t,e.id):Array.isArray(t)&&t.forEach((t=>{"string"==typeof t&&this.indexText(t,e.id)}))})))}indexText(e,t){const i=this.tokenize(e);new Set(i).forEach((e=>{e.length<=this.maxWordLength&&this.insertWord(e,t)}))}insertWord(e,t){let i=this.root;i.prefixCount++;for(const t of e)i=i.hasChild(t)?i.getChild(t):i.addChild(t),i.prefixCount++;i.isEndOfWord=!0,i.documentRefs.add(t),i.incrementWeight()}searchWord(e){return this.search(e)}search(e,t={}){const{fuzzy:i=!1,maxDistance:s=2,prefixMatch:r=!1,maxResults:n=10,minScore:o=.1,caseSensitive:a=!1}=t,c=this.tokenize(e,a),d=new Map;return c.forEach((e=>{let t=[];t=i?this.fuzzySearch(e,s):r?this.prefixSearch(e):this.exactSearch(e),t.forEach((e=>{const t=d.get(e.docId);(!t||t.score<e.score)&&d.set(e.docId,e)}))})),Array.from(d.values()).filter((e=>e.score>=o)).sort(((e,t)=>t.score-e.score)).slice(0,n)}exactSearch(e){const t=[];let i=this.root;for(const s of e){if(!i.hasChild(s))return t;i=i.getChild(s)}return i.isEndOfWord&&i.documentRefs.forEach((s=>{t.push({docId:s,score:this.calculateScore(i,e),term:e,id:"",document:this.documents.get(s),item:void 0,matches:[]})})),t}exportState(){return{trie:this.serializeTrie(this.root),documents:Array.from(this.documents.entries()),documentLinks:Array.from(this.documentLinks.entries()),totalDocuments:this.totalDocuments,maxWordLength:this.maxWordLength}}prefixSearch(e){const t=[];let i=this.root;for(const s of e){if(!i.hasChild(s))return t;i=i.getChild(s)}return this.collectWords(i,e,t),t}serializeState(){return{trie:this.serializeTrie(this.root),documents:Array.from(this.documents.entries()),documentLinks:Array.from(this.documentLinks.entries()),totalDocuments:this.totalDocuments,maxWordLength:this.maxWordLength}}deserializeState(e){if(!e||"object"!=typeof e)throw new Error("Invalid state data");const t=e;this.root=this.deserializeTrie(t.trie),this.documents=new Map(t.documents),this.documentLinks=new Map(t.documentLinks),this.totalDocuments=t.totalDocuments||0,this.maxWordLength=t.maxWordLength||50}serializeTrie(e){const t={prefixCount:e.prefixCount,isEndOfWord:e.isEndOfWord,documentRefs:Array.from(e.documentRefs),weight:e.getWeight(),children:{}};return e.children.forEach(((e,i)=>{t.children[i]=this.serializeTrie(e)})),t}addData(e,t,i){if(!e||"string"!=typeof t)return;const s={id:e,fields:{content:{text:t},title:i.fields.title||"",author:i.fields.author||"",tags:Array.isArray(i.fields.tags)?[...i.fields.tags]:[],version:i.fields.version||"1.0"},metadata:i.metadata?{...i.metadata}:void 0,versions:Array.isArray(i.versions)?[...i.versions]:[],relations:Array.isArray(i.relations)?[...i.relations]:[],document:()=>i,clone:()=>({...s}),update:e=>({...s,...e}),toObject:()=>({...s}),base:function(){throw new Error("Function not implemented.")},title:"",author:"",tags:[],version:""};this.addDocument(s)}deserializeTrie(e){const t=new o;t.prefixCount=e.prefixCount,t.isEndOfWord=e.isEndOfWord,t.documentRefs=new Set(e.documentRefs);for(const i in e.children)t.children.set(i,this.deserializeTrie(e.children[i]));return t}collectWords(e,t,i){e.isEndOfWord&&e.documentRefs.forEach((s=>{i.push({docId:s,score:this.calculateScore(e,t),term:t,id:"",document:this.documents.get(s),item:void 0,matches:[]})})),e.children.forEach(((e,s)=>{this.collectWords(e,t+s,i)}))}fuzzySearch(e,t){const i=[],s={word:e,maxDistance:t,results:i};return this.fuzzySearchRecursive(this.root,"",0,0,s),i}fuzzySearchRecursive(e,t,i,s,r){if(!(i>r.maxDistance)){if(e.isEndOfWord){const i=this.calculateLevenshteinDistance(r.word,t);i<=r.maxDistance&&e.documentRefs.forEach((s=>r.results.push({docId:s,score:this.calculateFuzzyScore(e,t,i),term:t,distance:i,id:"",document:this.documents.get(s),item:void 0,matches:[]})))}e.children.forEach(((n,o)=>{const a=o!==r.word[s]?1:0;this.fuzzySearchRecursive(n,t+o,i+a,s+1,r),this.fuzzySearchRecursive(n,t+o,i+1,s,r),s<r.word.length&&this.fuzzySearchRecursive(e,t,i+1,s+1,r)}))}}calculateScore(e,t){const i=e.frequency/this.totalDocuments*Math.log(this.totalDocuments/e.documentRefs.size),s=1/(e.depth+1),r=1/Math.sqrt(t.length);return e.getScore()*i*s*r}calculateFuzzyScore(e,t,i){return this.calculateScore(e,t)*Math.exp(-i)}calculateLevenshteinDistance(e,t){const i=Array(e.length+1).fill(0).map((()=>Array(t.length+1).fill(0)));for(let t=0;t<=e.length;t++)i[t][0]=t;for(let e=0;e<=t.length;e++)i[0][e]=e;for(let s=1;s<=e.length;s++)for(let r=1;r<=t.length;r++){const n=e[s-1]!==t[r-1]?1:0;i[s][r]=Math.min(i[s-1][r]+1,i[s][r-1]+1,i[s-1][r-1]+n)}return i[e.length][t.length]}tokenize(e,t=!1){return(t?e:e.toLowerCase()).split(/[\s,.!?;:'"()[\]{}/\\]+/).filter((e=>e.length>0))}removeDocument(e){this.removeDocumentRefs(this.root,e),this.documents.delete(e),this.documentLinks.delete(e),this.totalDocuments=Math.max(0,this.totalDocuments-1),this.pruneEmptyNodes(this.root)}removeDocumentRefs(e,t){e.documentRefs.has(t)&&(e.documentRefs.delete(t),e.decrementWeight(),e.prefixCount=Math.max(0,e.prefixCount-1)),e.children.forEach((e=>{this.removeDocumentRefs(e,t)}))}pruneEmptyNodes(e){return e.children.forEach(((t,i)=>{this.pruneEmptyNodes(t)&&e.children.delete(i)})),e.shouldPrune()}getSuggestions(e,t=5){let i=this.root;for(const t of e){if(!i.hasChild(t))return[];i=i.getChild(t)}const s=[];return this.collectSuggestions(i,e,s),s.sort(((e,t)=>t.score-e.score)).slice(0,t).map((e=>e.word))}collectSuggestions(e,t,i){e.isEndOfWord&&i.push({word:t,score:e.getScore()}),e.children.forEach(((e,s)=>{this.collectSuggestions(e,t+s,i)}))}clear(){this.root=new o,this.documents.clear(),this.documentLinks.clear(),this.totalDocuments=0}}class c{constructor(e){this.dataMapper=new n,(null==e?void 0:e.dataMap)&&this.dataMapper.importState(e.dataMap),this.trieSearch=new a,this.documents=new Map,this.documentScores=new Map}indexDocument(e,t,i){try{if(!e.content)return;const s={id:t,fields:{title:String(e.content.title||""),content:e.content.content,author:String(e.content.author||""),tags:Array.isArray(e.content.tags)?e.content.tags.filter((e=>"string"==typeof e)):[],version:String(e.content.version||"1.0"),...e.content},metadata:e.metadata||{},versions:[],relations:[],document:function(){return this},base:function(){throw new Error("Function not implemented.")},title:"",author:"",tags:[],version:""};this.documents.set(t,s),i.forEach((i=>{const s=e.content[i];if(null!=s){const e=this.normalizeValue(s);this.tokenizeText(e).forEach((e=>{e&&(this.trieSearch.insert(e,t),this.dataMapper.mapData(e.toLowerCase(),t))}))}}))}catch(e){throw console.error(`Error indexing document ${t}:`,e),new Error(`Failed to index document: ${e}`)}}search(e,t={}){try{const{fuzzy:i=!1,maxResults:s=10}=t,r=this.tokenizeText(e);return this.documentScores.clear(),r.forEach((e=>{if(!e)return;(i?this.trieSearch.fuzzySearch(e,2):this.trieSearch.search(e)).forEach((t=>{if("string"!=typeof t)return;const i=this.documentScores.get(t)||{score:0,matches:new Set};i.score+=this.calculateScore(t,e),i.matches.add(e),this.documentScores.set(t,i)}))})),Array.from(this.documentScores.entries()).map((([e,{score:t,matches:i}])=>{var s;return{id:e,document:this.documents.get(e),item:e,score:t/r.length,matches:Array.from(i),metadata:null===(s=this.documents.get(e))||void 0===s?void 0:s.metadata,docId:e,term:r.join(" ")}})).sort(((e,t)=>t.score-e.score)).slice(0,s)}catch(e){return console.error("Search error:",e),[]}}normalizeValue(e){return"string"==typeof e?e:Array.isArray(e)?e.map((e=>this.normalizeValue(e))).join(" "):"object"==typeof e&&null!==e?Object.values(e).map((e=>this.normalizeValue(e))).join(" "):String(e)}tokenizeText(e){return e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter((e=>e.length>0))}calculateScore(e,t){return(this.dataMapper.getDocuments(t.toLowerCase()).has(e)?1:.5)*(1+this.calculateTermFrequency(e,t))}calculateTermFrequency(e,t){const i=this.documents.get(e);if(!i)return 0;const s=Object.values(i.fields).join(" ").toLowerCase(),r=new RegExp(t,"gi"),n=s.match(r);return n?n.length:0}removeDocument(e){this.trieSearch.removeData(e),this.dataMapper.removeDocument(e),this.documents.delete(e),this.documentScores.delete(e)}addDocument(e,t,i){this.indexDocument(e,t,i)}updateDocument(e,t,i){this.removeDocument(t),this.indexDocument(e,t,i)}getDocumentById(e){return this.documents.get(e)}getAllDocuments(){return new Map(this.documents)}exportState(){return{trie:this.trieSearch.exportState(),dataMap:this.dataMapper.exportState(),documents:Array.from(this.documents.entries())}}importState(e){if(!e||!e.trie||!e.dataMap)throw new Error("Invalid index state");this.trieSearch=new a,this.trieSearch.deserializeState(e.trie);const t=new n;t.importState(e.dataMap),this.dataMapper=t,e.documents&&(this.documents=new Map(e.documents))}clear(){this.trieSearch=new a,this.dataMapper=new n,this.documents.clear(),this.documentScores.clear()}}function d(e,t){const{caseSensitive:i=!1,wholeWord:s=!1}=t;if(e instanceof RegExp){const t=`${i?"":"i"}${e.global?"g":""}`;return new RegExp(e.source,t)}let r=e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&");return s&&(r=`\\b${r}\\b`),new RegExp(r,i?"g":"ig")}function h(e,t,i){const s=e.score||1,r=t.match(i)||[];return s*r.length*(r.reduce(((e,t)=>e+t.length),0)/t.length)*(1/(e.depth||1))}function l(e,t){const i=[];let s;const r=new RegExp(t.source,t.flags+(t.global?"":"g"));for(;null!==(s=r.exec(e));)i.push([s.index,s.index+s[0].length]);return i}function u(e){return e&&"object"==typeof e?Array.isArray(e)?e.map(u):Object.keys(e).sort().reduce(((t,i)=>{const s=e[i];return t[i]="object"==typeof s&&null!==s?u(s):s,t}),{}):e}function m(e){if(!(null==e?void 0:e.id)||!e.content)return"";try{return`${e.id}:${Object.keys(e.content).sort().join(",")}`}catch(t){return e.id}}function f(e,t){if(!(null==e?void 0:e.content))return{};const i={};for(const s of t){const t=p(e.content,s);void 0!==t&&(i[`${s}_original`]=String(t),i[s]=g(t))}return i}function g(e){if(!e)return"";try{return"string"==typeof e?e.trim().replace(/\s+/g," "):Array.isArray(e)?e.map((e=>g(e))).filter(Boolean).join(" "):"object"==typeof e?Object.values(e).map((e=>g(e))).filter(Boolean).join(" "):String(e).trim()}catch(e){return console.warn("Error normalizing field value:",e),""}}function p(e,t){if(e&&t)try{return t.split(".").reduce(((e,t)=>null==e?void 0:e[t]),e)}catch(e){return void console.warn(`Error getting nested value for path ${t}:`,e)}}function w(e,t,i,s={}){const{fuzzy:r=!1,caseSensitive:n=!1,exactMatch:o=!1,fieldWeight:a=1}=s,c=e.fields[i];if(!c)return 0;const d=String(c),h=n?t:t.toLowerCase(),l=n?d:d.toLowerCase();let u=0;if(o&&l===h)return 1*a;const m=h.split(/\s+/),f=l.split(/\s+/);for(const e of m)for(const t of f)if(r){const i=1-y(e,t)/Math.max(e.length,t.length);i>=.8&&(u+=i*a)}else t.includes(e)&&(u+=a);return Math.min(u/m.length,1)}function y(e,t){const i=e.length,s=t.length,r=Array(i+1).fill(0).map((()=>Array(s+1).fill(0)));for(let e=0;e<=i;e++)r[e][0]=e;for(let e=0;e<=s;e++)r[0][e]=e;for(let n=1;n<=i;n++)for(let i=1;i<=s;i++)e[n-1]===t[i-1]?r[n][i]=r[n-1][i-1]:r[n][i]=Math.min(r[n-1][i],r[n][i-1],r[n-1][i-1])+1;return r[i][s]}function v(e,t,i,s={}){const r=new Set,n=s.caseSensitive?t:t.toLowerCase();for(const t of i){const i=e.fields[t];if(!i)continue;const o=s.caseSensitive?String(i):String(i).toLowerCase();if(s.fuzzy){const e=o.split(/\s+/),t=n.split(/\s+/);for(const i of t)for(const t of e){y(i,t)<=Math.min(2,Math.floor(t.length/3))&&r.add(t)}}else{const e=new RegExp(n,"gi");let t;for(;null!==(t=e.exec(o));)r.add(t[0])}}return Array.from(r)}class x{initialize(){this.documents=new Map,this.indexMapper=new c,this.config={name:"default",version:1,fields:["content"]}}importDocuments(e){e.forEach((e=>{this.documents.set(e.id,e)}))}getSize(){return this.documents.size}getAllDocuments(){return this.documents}constructor(e){this.config=e,this.indexMapper=new c,this.documents=new Map}addDocument(e){const t=e.id||this.generateDocumentId(this.documents.size);this.documents.set(t,e);const i={};for(const t of this.config.fields)t in e.fields&&(i[t]=e.fields[t]);const s={version:this.config.version.toString(),id:t,content:f({content:i,id:t,version:this.config.version.toString()},this.config.fields),metadata:e.metadata};this.indexMapper.indexDocument(s,t,this.config.fields)}getDocument(e){return this.documents.get(e)}exportIndex(){return{documents:Array.from(this.documents.entries()).map((([e,t])=>({key:e,value:this.serializeDocument(t)}))),indexState:this.indexMapper.exportState(),config:this.config}}importIndex(e){if(!this.isValidIndexData(e))throw new Error("Invalid index data format");try{const t=e;if(this.documents=new Map(t.documents.map((e=>[e.key,e.value]))),this.config=t.config,this.indexMapper=new c,!this.isValidIndexState(t.indexState))throw new Error("Invalid index state format");this.indexMapper.importState({trie:t.indexState.trie,dataMap:t.indexState.dataMap})}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to import index: ${t}`)}}clear(){this.documents.clear(),this.indexMapper=new c}generateDocumentId(e){return`${this.config.name}-${e}-${Date.now()}`}isValidIndexData(e){if(!e||"object"!=typeof e)return!1;const t=e;return Boolean(t.documents&&Array.isArray(t.documents)&&void 0!==t.indexState&&t.config&&"object"==typeof t.config)}isValidIndexState(e){return null!==e&&"object"==typeof e&&"trie"in e&&"dataMap"in e}serializeDocument(e){return JSON.parse(JSON.stringify(e))}async addDocuments(e){for(const t of e){const e=t.id||this.generateDocumentId(this.documents.size);try{const i={};for(const e of this.config.fields)e in t.fields&&(i[e]=t.fields[e]);const s={id:e,version:this.config.version.toString(),content:f({content:i,id:e,version:this.config.version.toString()},this.config.fields),metadata:t.metadata};this.documents.set(e,{...t,id:e}),await this.indexMapper.indexDocument(s,e,this.config.fields)}catch(t){console.warn(`Failed to index document ${e}:`,t)}}}async updateDocument(e){const t=e.id;if(!this.documents.has(t))throw new Error(`Document ${t} not found`);try{this.documents.set(t,e);const i={};for(const t of this.config.fields)t in e.fields&&(i[t]=e.fields[t]);const s={id:t,version:this.config.version.toString(),content:f({content:i,id:t,version:this.config.version.toString()},this.config.fields),metadata:e.metadata};await this.indexMapper.updateDocument(s,t,this.config.fields)}catch(e){throw console.error(`Failed to update document ${t}:`,e),e}}async removeDocument(e){try{this.documents.has(e)&&(await this.indexMapper.removeDocument(e),this.documents.delete(e))}catch(t){throw console.error(`Failed to remove document ${e}:`,t),t}}async search(e,t={}){var i,s;if(!(null==e?void 0:e.trim()))return[];try{return(await this.indexMapper.search(e,{fuzzy:null!==(i=t.fuzzy)&&void 0!==i&&i,maxResults:null!==(s=t.maxResults)&&void 0!==s?s:10})).filter((e=>this.documents.has(e.item))).map((t=>{const i=this.documents.get(t.item);return{id:i.id,docId:i.id,term:e,document:i,metadata:i.metadata,item:i,score:t.score,matches:t.matches}})).filter((e=>{var i;return e.score>=(null!==(i=t.threshold)&&void 0!==i?i:.5)}))}catch(e){return console.error("Search error:",e),[]}}hasDocument(e){return this.documents.has(e)}}class S{constructor(){this.STOP_WORDS=new Set(["a","an","and","are","as","at","be","by","for","from","has","he","in","is","it","its","of","on","that","the","to","was","were","will","with","this","they","but","have","had","what","when","where","who","which","why","how"]),this.WORD_ENDINGS={PLURAL:/(ies|es|s)$/i,GERUND:/ing$/i,PAST_TENSE:/(ed|d)$/i,COMPARATIVE:/er$/i,SUPERLATIVE:/est$/i,ADVERB:/ly$/i},this.SPECIAL_CHARS=/[!@#$%^&*(),.?":{}|<>]/g}process(e){if(!e)return"";const t=this.sanitizeQuery(String(e)),{phrases:i,remaining:s}=this.extractPhrases(t),r=this.tokenize(s),n=this.processTokens(r);return this.reconstructQuery(n,i)}sanitizeQuery(e){let t=e.trim().replace(/\s+/g," ");return t=t.replace(/"([^"]*"[^"]*"[^"]*)"/g,(e=>e)),t}extractPhrases(e){const t=[];let i=e;i=i.replace(/"([^"]*"[^"]*"[^"]*)"/g,(e=>(t.push(e)," ")));return i=i.replace(/"([^"]+)"|"([^"]*$)/g,((e,i,s)=>i||""===s?(t.push(`"${(i||"").trim()}"`)," "):"")),{phrases:t,remaining:i.trim()}}tokenize(e){return e.split(/\s+/).filter((e=>e.length>0)).map((e=>this.createToken(e)))}createToken(e){if(["+","-","!"].includes(e[0]))return{type:"operator",value:e.toLowerCase(),original:e};if(e.includes(":")){const[t,i]=e.split(":");return{type:"modifier",value:`${t.toLowerCase()}:${i}`,field:t,original:e}}return{type:"term",value:e.toLowerCase(),original:e}}processTokens(e){return e.filter((e=>this.shouldKeepToken(e))).map((e=>this.normalizeToken(e)))}shouldKeepToken(e){return"term"!==e.type||!this.STOP_WORDS.has(e.value.toLowerCase())}normalizeToken(e){if("term"!==e.type)return e;let t=e.value;return this.SPECIAL_CHARS.test(t)||(t=this.normalizeWordEndings(t)),{...e,value:t}}normalizeWordEndings(e){if(e.length<=3||this.isNormalizationException(e))return e;let t=e;return this.WORD_ENDINGS.SUPERLATIVE.test(t)?t=t.replace(this.WORD_ENDINGS.SUPERLATIVE,""):this.WORD_ENDINGS.COMPARATIVE.test(t)?t=t.replace(this.WORD_ENDINGS.COMPARATIVE,""):this.WORD_ENDINGS.GERUND.test(t)?t=this.normalizeGerund(t):this.WORD_ENDINGS.PAST_TENSE.test(t)?t=this.normalizePastTense(t):this.WORD_ENDINGS.PLURAL.test(t)&&(t=this.normalizePlural(t)),t}isNormalizationException(e){return new Set(["this","his","is","was","has","does","series","species","test","tests"]).has(e.toLowerCase())}normalizeGerund(e){return/[^aeiou]{2}ing$/.test(e)?e.slice(0,-4):/ying$/.test(e)?e.slice(0,-4)+"y":e.slice(0,-3)}normalizePastTense(e){return/[^aeiou]{2}ed$/.test(e)?e.slice(0,-3):/ied$/.test(e)?e.slice(0,-3)+"y":e.slice(0,-2)}normalizePlural(e){return"tests"===e||"test"===e?"test":/ies$/.test(e)?e.slice(0,-3)+"y":/[sxz]es$|[^aeiou]hes$/.test(e)?e.slice(0,-2):e.slice(0,-1)}reconstructQuery(e,t){return[...t,e.map((e=>"operator"===e.type?e.original:e.value)).join(" ")].filter((e=>e.length>0)).join(" ").trim().replace(/\s+/g," ")}}class E{constructor(e){var t,r,n,o;if(this.trie=new a,this.isInitialized=!1,!e||!e.name)throw new Error("Invalid search engine configuration");this.config={...e,search:{...e.search,defaultOptions:(null===(t=e.search)||void 0===t?void 0:t.defaultOptions)||{}}},this.documentSupport=null!==(n=null===(r=e.documentSupport)||void 0===r?void 0:r.enabled)&&void 0!==n&&n,this.indexManager=new x({name:e.name,version:e.version,fields:e.fields,options:null===(o=e.search)||void 0===o?void 0:o.defaultOptions}),this.queryProcessor=new S,this.storage=new s(e.storage),this.cache=new i,this.trie.clear(),this.documents=new Map,this.eventListeners=new Set,this.trieRoot={id:"",value:"",score:0,children:new Map,depth:0},this.search=this.search.bind(this),this.addDocument=this.addDocument.bind(this),this.removeDocument=this.removeDocument.bind(this)}async initialize(){if(!this.isInitialized)try{await this.storage.initialize(),this.indexManager.initialize(),await this.loadExistingIndexes(),this.isInitialized=!0,this.emitEvent({type:"engine:initialized",timestamp:Date.now()})}catch(e){const t=e instanceof Error?e.message:String(e);throw new Error(`Failed to initialize search engine: ${t}`)}}async loadExistingIndexes(){try{const e=await this.storage.getIndex(this.config.name);if(e){this.indexManager.importIndex(e);const t=this.indexManager.getAllDocuments();for(const[e,i]of t)this.documents.set(e,i),this.trie.addDocument(i)}}catch(e){console.warn("Failed to load stored indexes:",e)}}extractRegexMatches(e,t,i){const s=i.fields||this.config.fields,r=new Set;for(const i of s){const s=String(e.fields[i]||"");for(const[e,i]of t)e>=0&&i<=s.length&&r.add(s.slice(e,i))}return Array.from(r)}async addDocument(e){this.isInitialized||await this.initialize();const t=this.normalizeDocument(e);if(!this.validateDocument(t))throw new Error(`Invalid document structure: ${e.id}`);try{this.documents.set(t.id,t);const e=new r(t.id,{...t.fields,links:(t.links||[]).map((e=>e.url)),ranks:(t.ranks||[]).map((e=>({id:"",rank:e.rank,source:"",target:"",fromId:()=>"",toId:()=>"",incomingLinks:0,outgoingLinks:0,content:{}}))),content:this.normalizeContent(t.content)},t.metadata);this.indexManager.addDocument(e)}catch(e){throw new Error(`Failed to add document: ${e}`)}}async addDocuments(e){for(const t of e)await this.addDocument(t)}async search(e,t={}){var i,s;if(this.isInitialized||await this.initialize(),!e.trim())return[];const r={...null===(i=this.config.search)||void 0===i?void 0:i.defaultOptions,...t,fields:t.fields||this.config.fields};try{const t=this.queryProcessor.process(e);if(!t)return[];const i=new Map;for(const e of r.fields)for(const[n,o]of this.documents){const a=w(o,t,e,{fuzzy:r.fuzzy,caseSensitive:r.caseSensitive,fieldWeight:(null===(s=r.boost)||void 0===s?void 0:s[e])||1});if(a>0){const s=i.get(n);if(!s||a>s.score){const s=v(o,t,[e],{fuzzy:r.fuzzy,caseSensitive:r.caseSensitive});i.set(n,{id:n,docId:n,item:o,score:a,matches:s,metadata:{...o.metadata,lastAccessed:Date.now()},document:o,term:t})}}}let n=Array.from(i.values()).sort(((e,t)=>t.score-e.score));return r.maxResults&&(n=n.slice(0,r.maxResults)),n}catch(e){throw console.error("Search error:",e),new Error(`Search failed: ${e}`)}}normalizeDocument(e){var t,i;return new r(e.id,{...e.fields,title:e.fields.title||"",content:e.fields.content||"",author:e.fields.author||"",tags:Array.isArray(e.fields.tags)?e.fields.tags:[],version:e.fields.version||"1.0"},{...e.metadata,indexed:(null===(t=e.metadata)||void 0===t?void 0:t.indexed)||Date.now(),lastModified:(null===(i=e.metadata)||void 0===i?void 0:i.lastModified)||Date.now()})}validateDocument(e){return"string"==typeof e.id&&e.id.length>0&&"object"==typeof e.fields&&null!==e.fields}normalizeContent(e){return e?"string"==typeof e?{text:e}:"object"==typeof e?e:{value:String(e)}:{}}normalizeDate(e){if(e)return e instanceof Date?e.toISOString():"string"==typeof e||"number"==typeof e?new Date(e).toISOString():void 0}normalizeStatus(e){if(!e)return;const t=String(e).toLowerCase();switch(t){case"draft":case"published":case"archived":return t;case"active":return"published";default:return"draft"}}async updateDocument(e){var t,i;this.isInitialized||await this.initialize();const s=this.normalizeDocument(e);await this.handleVersioning(s),this.documentSupport&&(null===(i=null===(t=this.config.documentSupport)||void 0===t?void 0:t.versioning)||void 0===i?void 0:i.enabled)&&await this.handleVersioning(s),this.documents.set(s.id,s),this.trie.addDocument(s),await this.indexManager.updateDocument(s)}async performRegexSearch(e,t){var i,s,r,n;const o={maxDepth:(null===(i=t.regexConfig)||void 0===i?void 0:i.maxDepth)||50,timeoutMs:(null===(s=t.regexConfig)||void 0===s?void 0:s.timeoutMs)||5e3,caseSensitive:(null===(r=t.regexConfig)||void 0===r?void 0:r.caseSensitive)||!1,wholeWord:(null===(n=t.regexConfig)||void 0===n?void 0:n.wholeWord)||!1},a=this.createRegexFromOption(t.regex||""),c=this.isComplexRegex(a)?function(e,t,i=10,s={}){const{maxDepth:r=50,timeoutMs:n=5e3,caseSensitive:o=!1,wholeWord:a=!1}=s,c=d(t,{caseSensitive:o,wholeWord:a}),u=[],m=new Set,f=Date.now();return function e(t,s,o,a){if(!(u.length>=i||o>r||Date.now()-f>n)){c.test(s)&&t.id&&!m.has(t.id)&&(u.push({id:t.id,score:h(t,s,c),matches:[s],path:[...a],positions:l(s,c)}),m.add(t.id));for(const[i,r]of t.children.entries())e(r,s+i,o+1,[...a,i])}}(e,"",0,[]),u.sort(((e,t)=>t.score-e.score))}(this.trieRoot,a,t.maxResults||10,o):function(e,t,i=10,s={}){const{maxDepth:r=50,timeoutMs:n=5e3,caseSensitive:o=!1,wholeWord:a=!1}=s,c=d(t,{caseSensitive:o,wholeWord:a}),u=[],m=[],f=new Set,g=Date.now();for(m.push({node:e,matched:"",depth:0,path:[]});m.length>0&&u.length<i;){if(Date.now()-g>n){console.warn("BFS regex search timeout");break}const e=m.shift(),{node:t,matched:i,depth:s,path:o}=e;if(!(s>r)){c.test(i)&&t.id&&!f.has(t.id)&&(u.push({id:t.id,score:h(t,i,c),matches:[i],path:[...o],positions:l(i,c)}),f.add(t.id));for(const[e,r]of t.children.entries())m.push({node:r,matched:i+e,depth:s+1,path:[...o,e]})}}return u.sort(((e,t)=>t.score-e.score))}(this.trieRoot,a,t.maxResults||10,o);return c.map((t=>{const i=this.documents.get(t.id);if(!i)throw new Error(`Document not found for id: ${t.id}`);return{id:t.id,docId:t.id,term:t.matches[0]||e,score:t.score,matches:t.matches,document:i,item:i,metadata:{...i.metadata,lastAccessed:Date.now()}}})).filter((e=>e.score>=(t.minScore||0)))}async performBasicSearch(e,t){const i=new Map;for(const s of e){const e=t.fuzzy?this.trie.fuzzySearch(s,t.maxDistance||2):this.trie.search(s);for(const r of e){const e=r.docId,n=i.get(e)||{score:0,matches:new Set};n.score+=this.calculateTermScore(s,e,t),n.matches.add(s),i.set(e,n)}}return Array.from(i.entries()).map((([e,{score:t}])=>({id:e,score:t}))).sort(((e,t)=>t.score-e.score))}createRegexFromOption(e){if(e instanceof RegExp)return e;if("string"==typeof e)return new RegExp(e);if("object"==typeof e&&null!==e){const t="object"==typeof e&&null!==e&&"pattern"in e?e.pattern:"",i="object"==typeof e&&null!==e&&"flags"in e?e.flags:"";return new RegExp(t||"",i||"")}return new RegExp("")}isComplexRegex(e){const t=e.source;return t.includes("{")||t.includes("+")||t.includes("*")||t.includes("?")||t.includes("|")||t.includes("(?")||t.includes("[")||t.length>20}async processSearchResults(e,t){const i=[];for(const s of e){const e=this.documents.get(s.id);if(!e)continue;const r={id:s.id,docId:s.id,item:e,score:s.score?this.normalizeScore(s.score):s.score,matches:[],metadata:{...e.metadata,lastAccessed:Date.now()},document:e,term:"matched"in s?String(s.matched):""};t.includeMatches&&(r.matches="positions"in s?this.extractRegexMatches(e,s.positions,t):this.extractMatches(e,t)),i.push(r)}return this.applyPagination(i,t)}getTrieState(){return this.trie.serializeState()}async removeDocument(e){if(this.isInitialized||await this.initialize(),!this.documents.has(e))throw new Error(`Document ${e} not found`);try{this.documents.delete(e),this.trie.removeDocument(e),await this.indexManager.removeDocument(e),this.cache.clear();try{await this.storage.storeIndex(this.config.name,this.indexManager.exportIndex())}catch(e){this.emitEvent({type:"storage:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))})}this.emitEvent({type:"remove:complete",timestamp:Date.now(),data:{documentId:e}})}catch(e){throw this.emitEvent({type:"remove:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Failed to remove document: ${e}`)}}async clearIndex(){this.isInitialized||await this.initialize();try{await this.storage.clearIndices(),this.documents.clear(),this.trie.clear(),this.indexManager.clear(),this.cache.clear(),this.emitEvent({type:"index:clear",timestamp:Date.now()})}catch(e){throw this.emitEvent({type:"index:clear:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Failed to clear index: ${e}`)}}calculateTermScore(e,t,i){var s;const r=this.documents.get(t);if(!r)return 0;const n=i.fields||this.config.fields;let o=0;for(const t of n){const n=String(r.fields[t]||"").toLowerCase(),a=(null===(s=i.boost)||void 0===s?void 0:s[t])||1;o+=(n.match(new RegExp(e,"gi"))||[]).length*a}return o}normalizeScore(e){return Math.min(Math.max(e/100,0),1)}extractMatches(e,t){const i=new Set,s=t.fields||this.config.fields;for(const r of s){const s=String(e.fields[r]||"").toLowerCase();if(t.regex){const e="string"==typeof t.regex?new RegExp(t.regex,"gi"):new RegExp(t.regex.source,"gi");(s.match(e)||[]).forEach((e=>i.add(e)))}}return Array.from(i)}applyPagination(e,t){const i=t.page||1,s=t.pageSize||10,r=(i-1)*s;return e.slice(r,r+s)}async loadIndexes(){try{const e=await this.storage.getIndex(this.config.name);if(e){this.indexManager.importIndex(e);const t=this.indexManager.getAllDocuments();for(const e of t)this.documents.set(e[1].id,r.fromObject({id:e[1].id,fields:{title:e[1].fields.title,content:e[1].fields.content,author:e[1].fields.author,tags:e[1].fields.tags,version:e[1].fields.version},metadata:e[1].metadata}))}}catch(e){console.warn("Failed to load stored index, starting fresh:",e)}}generateCacheKey(e,t){return`${this.config.name}-${e}-${JSON.stringify(t)}`}addEventListener(e){this.eventListeners.add(e)}removeEventListener(e){this.eventListeners.delete(e)}emitEvent(e){this.eventListeners.forEach((t=>{try{t(e)}catch(e){console.error("Error in event listener:",e)}}))}async close(){try{await this.storage.close(),this.cache.clear(),this.documents.clear(),this.isInitialized=!1,this.emitEvent({type:"engine:closed",timestamp:Date.now()})}catch(e){console.warn("Error during close:",e)}}getIndexedDocumentCount(){return this.documents.size}async bulkUpdate(e){this.isInitialized||await this.initialize();const t=[];for(const[i,s]of e){const e=this.documents.get(i);if(e){const n=new r(i,{...e.fields,...s.fields},{...e.metadata,...s.metadata});t.push(this.updateDocument(n))}}try{await Promise.all(t),this.emitEvent({type:"bulk:update:complete",timestamp:Date.now(),data:{updateCount:e.size}})}catch(e){throw this.emitEvent({type:"bulk:update:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Bulk update failed: ${e}`)}}async importIndex(e){this.isInitialized||await this.initialize();try{await this.clearIndex(),this.indexManager.importIndex(e);const t=Array.from(this.documents.values()).map((e=>r.fromObject(e)));await this.addDocuments(t),this.emitEvent({type:"import:complete",timestamp:Date.now(),data:{documentCount:this.documents.size}})}catch(e){throw this.emitEvent({type:"import:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Import failed: ${e}`)}}exportIndex(){if(!this.isInitialized)throw new Error("Search engine not initialized");return this.indexManager.exportIndex()}getDocument(e){return this.documents.get(e)}getAllDocuments(){return Array.from(this.documents.values())}async reindexAll(){this.isInitialized||await this.initialize();try{const e=this.getAllDocuments();await this.clearIndex(),await this.addDocuments(e),this.emitEvent({type:"reindex:complete",timestamp:Date.now(),data:{documentCount:e.length}})}catch(e){throw this.emitEvent({type:"reindex:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Reindex failed: ${e}`)}}async optimizeIndex(){this.isInitialized||await this.initialize();try{this.cache.clear(),this.storage instanceof s&&(await this.storage.clearIndices(),await this.storage.storeIndex(this.config.name,this.indexManager.exportIndex())),this.emitEvent({type:"optimize:complete",timestamp:Date.now()})}catch(e){throw this.emitEvent({type:"optimize:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Optimization failed: ${e}`)}}async handleVersioning(e){var t,i,s;const r=this.getDocument(e.id);if(!r)return;const n=null!==(s=null===(i=null===(t=this.config.documentSupport)||void 0===t?void 0:t.versioning)||void 0===i?void 0:i.maxVersions)&&void 0!==s?s:10,o=r.versions||[];e.fields.content!==r.fields.content&&(o.push({version:Number(r.fields.version),content:r.fields.content,modified:new Date(r.fields.modified||Date.now()),author:r.fields.author}),o.length>n&&o.splice(0,o.length-n),e.versions=o,e.fields.version=String(Number(e.fields.version)+1))}async restoreVersion(e,t){if(!this.documentSupport)throw new Error("Document support is not enabled");const i=this.getDocument(e);if(!i)throw new Error(`Document ${e} not found`);const s=await this.getDocumentVersion(e,t);if(!s)throw new Error(`Version ${t} not found for document ${e}`);const n=new r(i.id,{...i.fields,content:this.normalizeContent(s.content),modified:(new Date).toISOString(),version:String(Number(i.fields.version)+1)},{...i.metadata,lastModified:Date.now()});await this.updateDocument(n)}async getDocumentVersion(e,t){var i;if(!this.documentSupport)throw new Error("Document support is not enabled");const s=this.getDocument(e);return null===(i=null==s?void 0:s.versions)||void 0===i?void 0:i.find((e=>e.version===t))}getStats(){return{documentCount:this.documents.size,indexSize:this.indexManager.getSize(),cacheSize:this.cache.getSize(),initialized:this.isInitialized}}isReady(){return this.isInitialized}}class D extends Error{constructor(e){super(e),this.name="ValidationError"}}class z extends Error{constructor(e){super(e),this.name="StorageError"}}class M extends Error{constructor(e){super(e),this.name="CacheError"}}class b extends Error{constructor(e){super(e),this.name="MapperError"}}class I extends Error{constructor(e){super(e),this.name="PerformanceError"}}class A extends Error{constructor(e){super(e),this.name="ConfigError"}}class R extends Error{constructor(e,t,i){super(e),this.type=t,this.details=i,this.name="SearchEventError"}}var O;e.CacheStrategyType=void 0,(O=e.CacheStrategyType||(e.CacheStrategyType={})).LRU="LRU",O.MRU="MRU";class C extends Error{constructor(e){super(e),this.name="SearchError"}}class $ extends Error{constructor(e){super(e),this.name="IndexError"}}function L(e){if(!e||"object"!=typeof e)return!1;const t=e;return(void 0===t.fuzzy||"boolean"==typeof t.fuzzy)&&(void 0===t.maxResults||"number"==typeof t.maxResults)&&(void 0===t.threshold||"number"==typeof t.threshold)&&(void 0===t.fields||Array.isArray(t.fields))&&(void 0===t.sortBy||"string"==typeof t.sortBy)&&(void 0===t.sortOrder||["asc","desc"].includes(t.sortOrder))&&(void 0===t.page||"number"==typeof t.page)&&(void 0===t.pageSize||"number"==typeof t.pageSize)&&(void 0===t.regex||"string"==typeof t.regex||t.regex instanceof RegExp)&&(void 0===t.boost||"object"==typeof t.boost&&null!==t.boost)}function k(e){if(!e||"object"!=typeof e)return!1;const t=e;return Boolean("string"==typeof t.name&&"number"==typeof t.version&&Array.isArray(t.fields))}function T(e){if(!e||"object"!=typeof e)return!1;const t=e;return Boolean("id"in t&&"item"in t&&"document"in t&&"number"==typeof t.score&&Array.isArray(t.matches))}const N={DEFAULT_INDEX_OPTIONS:{fields:[]},DEFAULT_SEARCH_OPTIONS:{fuzzy:!1,fields:[],boost:{},maxResults:10,threshold:.5,sortBy:"score",sortOrder:"desc",page:1,pageSize:10,highlight:!1,includeMatches:!1,includeScore:!1,includeStats:!1,enableRegex:!1,maxDistance:0,regex:/./,prefixMatch:!1,minScore:0,includePartial:!1,caseSensitive:!1},SearchError:C,IndexError:$,SearchEngine:E,IndexManager:x,QueryProcessor:S,TrieNode:o,TrieSearch:a,isSearchOptions:L,isIndexConfig:k,isSearchResult:T};"undefined"!=typeof window&&(window.NexusSearch=N);const W=N;e.CacheError=M,e.CacheManager=i,e.ConfigError=A,e.DataMapper=n,e.IndexError=$,e.IndexManager=x,e.IndexMapper=c,e.IndexedDB=class{constructor(){this.db=null,this.DB_NAME="nexus_search_db",this.DB_VERSION=1,this.initPromise=null,this.initPromise=this.initialize()}async initialize(){if(!this.db)try{this.db=await t.openDB(this.DB_NAME,this.DB_VERSION,{upgrade(e){if(!e.objectStoreNames.contains("searchIndices")){e.createObjectStore("searchIndices",{keyPath:"id"}).createIndex("timestamp","timestamp")}if(!e.objectStoreNames.contains("metadata")){e.createObjectStore("metadata",{keyPath:"id"}).createIndex("lastUpdated","lastUpdated")}},blocked(){console.warn("Database upgrade was blocked")},blocking(){console.warn("Current database version is blocking a newer version")},terminated(){console.error("Database connection was terminated")}})}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Storage initialization failed: ${t}`)}}async ensureConnection(){if(this.initPromise&&await this.initPromise,!this.db)throw new Error("Database connection not available")}async storeIndex(e,t){await this.ensureConnection();try{const i={id:e,data:t,timestamp:Date.now()};await this.db.put("searchIndices",i)}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to store index: ${t}`)}}async getIndex(e){var t;await this.ensureConnection();try{const i=await this.db.get("searchIndices",e);return null!==(t=null==i?void 0:i.data)&&void 0!==t?t:null}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to retrieve index: ${t}`)}}async updateMetadata(e){await this.ensureConnection();try{const t={id:"config",config:e,lastUpdated:Date.now()};await this.db.put("metadata",t)}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to update metadata: ${t}`)}}async getMetadata(){await this.ensureConnection();try{const e=await this.db.get("metadata","config");return null!=e?e:null}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to retrieve metadata: ${t}`)}}async clearIndices(){await this.ensureConnection();try{await this.db.clear("searchIndices")}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to clear indices: ${t}`)}}async deleteIndex(e){await this.ensureConnection();try{await this.db.delete("searchIndices",e)}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to delete index: ${t}`)}}async close(){this.db&&(this.db.close(),this.db=null)}},e.MapperError=b,e.NexusSearch=W,e.PerformanceError=I,e.PerformanceMonitor=class{constructor(){this.metrics=new Map}async measure(e,t){const i=performance.now();try{return await t()}finally{const t=performance.now()-i;this.recordMetric(e,t)}}recordMetric(e,t){this.metrics.has(e)||this.metrics.set(e,[]),this.metrics.get(e).push(t)}getMetrics(){const e={};return this.metrics.forEach(((t,i)=>{e[i]={avg:this.average(t),min:Math.min(...t),max:Math.max(...t),count:t.length}})),e}average(e){return e.reduce(((e,t)=>e+t),0)/e.length}clear(){this.metrics.clear()}},e.QueryProcessor=S,e.SearchEngine=E,e.SearchError=C,e.SearchEventError=R,e.StorageError=z,e.TrieNode=o,e.TrieSearch=a,e.ValidationError=D,e.createSearchableFields=f,e.default=W,e.getNestedValue=p,e.isIndexConfig=k,e.isSearchOptions=L,e.isSearchResult=T,e.normalizeFieldValue=g,e.optimizeIndex=function(e){if(!Array.isArray(e))return{data:[],stats:{originalSize:0,optimizedSize:0,compressionRatio:1}};try{const t=new Map;e.forEach((e=>{const i=JSON.stringify(u(e));t.set(i,e)}));const i=Array.from(t.values()).sort(((e,t)=>m(e).localeCompare(m(t))));return{data:i,stats:{originalSize:e.length,optimizedSize:i.length,compressionRatio:e.length?i.length/e.length:1}}}catch(t){return console.warn("Error optimizing index:",t),{data:e,stats:{originalSize:e.length,optimizedSize:e.length,compressionRatio:1}}}},e.validateDocument=function(e,t){return t.every((t=>void 0!==p(e.content,t)))},e.validateIndexConfig=function(e){if(!e.name)throw new Error("Index name is required");if(!e.version||"number"!=typeof e.version)throw new Error("Valid version number is required");if(!Array.isArray(e.fields)||0===e.fields.length)throw new Error("At least one field must be specified for indexing")},e.validateSearchOptions=function(e){if(e.maxResults&&e.maxResults<1)throw new Error("maxResults must be greater than 0");if(e.threshold&&(e.threshold<0||e.threshold>1))throw new Error("threshold must be between 0 and 1");if(e.fields&&!Array.isArray(e.fields))throw new Error("fields must be an array")},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.js.map
